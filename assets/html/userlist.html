<html>
    <head>
        <script src="../js/jquery_mini.js"></script>
    </head>
    <body>
        <h3 id="idBusname" align="center" >Welcome</h3>
        <div id="idStations">
        </div>
        <p id="console"></p>
        <script>
            function dbg(msg){
                $("#console").html(msg+"<br>"+$("#console").html());
            }
            $(document).ready(function(){
                dbg("ok ready");
                var info=window.buss.getBusInfo();
                if(info==""){
                    return;
                }
                businfo= JSON.parse(info);
                $("#idBusname").text(businfo.name);
                var stations="";
                for(var i=0;i<businfo.stationUp.length;i++){
                    stations+="<p id='idstation"+i+"'>"+businfo.stationUp[i].stname;
                    stations+="&nbsp;<span align='right' id='idstTm"+i+"'></span>";
                    stations+="&nbsp;<span align='right' id='idstDist"+i+"'></span>";
                    stations+="&nbsp;<span align='right' id='idstSpeed"+i+"'></span>";
                    stations+="</p>";
                }
                $("#idStations").html(stations);
                tstime();

            });
            function getHMS(timstap){
                var ts=new Date(timstap).toLocaleString();
                //dbg(timstap+"=>"+ts);
                return ts.split(" ")[4];
            }
            function start(){
                try{
                    start_();
                }catch(e){
                    dbg("error:"+e.name+":"+e.message);
                }
            }
            var MIN_IN_STATION_DIST=50;
            var mStartBus=false;
            function start_(){
                if(!mLatestLoc){
                    dbg("no Gps!!");
                    return;
                }
                mStartLoc=(mLatestLoc);
                var ls=businfo.stationUp;
                var dist=MIN_IN_STATION_DIST;
                for(var i=0;i<ls.length;i++){
                    var thisdist=(getDisance(mStartLoc.la,mStartLoc.lo,ls[i].la,ls[i].lo));
                    dbg("thisdist from "+ls[i].stname+"="+thisdist);
                    $("#idstation"+i).css("color","#0000E3");//blue
                    if(thisdist<dist){
                        dist=thisdist;
                        mCurrStationIndex=i;
                        mNextSationIndex=i+1;
                        mStartBus=true;
                        $("#idstation"+mCurrStationIndex).css("color","#F9F900");//yellow
                    }
                }
                if(mStartBus){
                    dbg("get start station "+ls[mCurrStationIndex].stname);
                    for(var i=0;i<mCurrStationIndex;i++){
                        $("#idstation"+i).css("color","#6C0000");//red for passed station
                    }
                    updateStaion();
                }else{
                    dbg("too far from any station");
                }
            }
            function updateStaion(){//in station : yellow ; left staion : green , done station : red
                if(!mStartBus){
                    return;
                }
                dbg("u: cur="+mCurrStationIndex+",next="+mNextSationIndex);
                var ls=businfo.stationUp,dist,nextStationIndex,speedDistIndex,thisdist="";
                var tm=new Date().getTime();
                if(mCurrStationIndex>=0){
                    thisdist=(getDisance(mLatestLoc.la,mLatestLoc.lo,ls[mCurrStationIndex].la,ls[mCurrStationIndex].lo));
                    dbg("u:c: dist from cur "+ls[mCurrStationIndex].stname+" = "+thisdist);
                    //dbg(" >MIN="+(thisdist>MIN_IN_STATION_DIST)+" typeof thisdist= "+(typeof thisdist)+",typeof MIN="+(typeof MIN_IN_STATION_DIST));
                    updateDistSpeed(mCurrStationIndex,thisdist);
                    $("#idstTm"+mCurrStationIndex).html(getHMS(tm));
                    if(thisdist>MIN_IN_STATION_DIST){//leave curr
                        $("#idstation"+mCurrStationIndex).css("color","#6C0000");//red
                        ls[mCurrStationIndex].leaveTm=tm;
                        $("#idstSpeed"+mCurrStationIndex).html("");
                        $("#idstDist"+mCurrStationIndex).html("");
                        mNextSationIndex=mCurrStationIndex+1;
                        mCurrStationIndex=-1;
                    }
                }else if(mNextSationIndex>0 && mNextSationIndex<ls.length){
                    thisdist=(getDisance(mLatestLoc.la,mLatestLoc.lo,ls[mNextSationIndex].la,ls[mNextSationIndex].lo));
                    dbg("u:n: dist from next "+ls[mNextSationIndex].stname+" = "+thisdist);
                    updateDistSpeed(mNextSationIndex,thisdist);
                    $("#idstTm"+mCurrStationIndex).html(getHMS(tm));
                    if(thisdist<=MIN_IN_STATION_DIST){//enter next
                        mCurrStationIndex=mNextSationIndex;
                        mNextSationIndex++;
                        $("#idstation"+mCurrStationIndex).css("color","#F9F900");//yellow
                    }
                }

            }
            function updateDistSpeed(speedDistIndex,dist){
                $("#idstDist"+speedDistIndex).html("距离:"+dist);
                if("speed" in mLatestLoc){
                    $("#idstSpeed"+speedDistIndex).html("速度:"+mLatestLoc.speed);
                }
            }
            function onGpsPos(loc){
                try{
                    dbg("onGpsPos loc="+loc);
                    mLatestLoc=JSON.parse(loc);
                    updateStaion();
                }catch(e){
                    dbg("us error:"+e.name+":"+e.message);
                }
            }
            function toRad(d) {  return d * Math.PI / 180; }
            function getDisance(lat1, lng1, lat2, lng2) { //lat为纬度, lng为经度, 一定不要弄错
                //dbg("gd ["+lat1+","+lng1+"]->["+lat2+","+lng2+"]");
                var dis = 0;
                var radLat1 = toRad(lat1);
                var radLat2 = toRad(lat2);
                var deltaLat = radLat1 - radLat2;
                var deltaLng = toRad(lng1) - toRad(lng2);
                var dis = 2 * Math.asin(Math.sqrt(Math.pow(Math.sin(deltaLat / 2), 2) + Math.cos(radLat1) * Math.cos(radLat2) * Math.pow(Math.sin(deltaLng / 2), 2)));
                return parseInt(dis * 6378137);
            } 
        </script>
    </body>
</html>

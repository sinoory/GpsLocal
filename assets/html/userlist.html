<html>
    <head>
        <script src="../js/jquery_mini.js"></script>
    </head>
    <body>
        <h3 id="idBusname" align="center" >Welcome</h3>
        <div id="idStations">
        </div>
        <div id='idopr'>
        </div>
        <p id="console"></p>
        <script>
            function dbg(msg){
                $("#console").html(msg+"<br>"+$("#console").html());
            }
            var DBG=false;
            $(document).ready(function(){
                try{
                    readFunc();
                }catch(e){
                    dbg("ready e="+e);
                }
            });
            function readFunc(){
                dbg("ok ready A");
                var info;
                getIdIfNeed();
                if(!DBG){
                    info=window.buss.getBusInfo();
                    if(info==""){
                        return;
                    }
                    businfo= JSON.parse(info);
                }else{
                    info="{&quot;stationDn&quot;:[],&quot;stations&quot;:[{&quot;la&quot;:&quot;31.216691&quot;,&quot;lo&quot;:&quot;121.626835&quot;,&quot;stname&quot;:&quot;AAAA&quot;},{&quot;lo&quot;:&quot;121.629542&quot;,&quot;la&quot;:&quot;31.221043&quot;,&quot;stname&quot;:&quot;BBBBB&quot;},{&quot;la&quot;:&quot;31.226894&quot;,&quot;lo&quot;:&quot;121.63886&quot;,&quot;stname&quot;:&quot;CCCC&quot;},{&quot;lo&quot;:&quot;121.639386&quot;,&quot;la&quot;:&quot;31.228422&quot;,&quot;stname&quot;:&quot;DDDD&quot;},{&quot;la&quot;:&quot;31.243441&quot;,&quot;lo&quot;:&quot;121.638352&quot;,&quot;stname&quot;:&quot;EEEE&quot;}],&quot;name&quot;:&quot;BBBB&quot;}";
                    businfo= JSON.parse(info.replace(/&quot;/g,"\""));
                }
                $("#idBusname").text(businfo.name);
                var stations="";
                for(var i=0;i<businfo.stations.length;i++){
                    stations+="<p id='idstation"+i+"'>"+businfo.stations[i].stname;
                    stations+="&nbsp;<span align='right' id='idstTm"+i+"'></span>";
                    stations+="&nbsp;<span align='right' id='idstDist"+i+"'></span>";
                    stations+="&nbsp;<span align='right' id='idstSpeed"+i+"'></span>";
                    stations+="</p>";
                }
                $("#idStations").html(stations);
                var oprhtml="";
                dbg("line ownid="+businfo.ownerid+",my id="+jlh.getShp("id"));
                if(!businfo.ownerid || businfo.ownerid==jlh.getShp("id")){
                    oprhtml="<button id='idstart' onclick='start()'>start</button>";
                }else{
                    oprhtml="<button id='idwatch' onclick='watch()'>watch</button>";
                }
                $("#idopr").html(oprhtml);
            }
            function getHMS(timstap){
                var ts=new Date(timstap);
                return ts.getHours()+":"+ts.getMinutes()+":"+ts.getSeconds();
            }
            function start(){
                try{
                    start_();
                }catch(e){
                    dbg("error:"+e.name+":"+e.message);
                }
            }
            function watch(){
                if(!userId){
                    dbg("no userId,ignore watch");
                    return;
                }
                buss.sendMsg(JSON.stringify(
                    {'type':'watchline','lineid':businfo.lineid,'watcher':userId}));
            }
            function reportOnline(userid){
                buss.sendMsg(JSON.stringify({type:'online',userid:userid}));
            }
            var userId="";
            function getIdIfNeed(){
                userId=jlh.getShp("id");
                if(!userId){
                    var devid=buss.getDeviceId();
                    dbg("no id,devid="+devid); 
                    buss.sendMsg(JSON.stringify({type:'querryid',devid:devid}));
                }else{
                    reportOnline(userId);
                }
            }
            function test(){
                try{
                dbg("next send msg");
                var js={"type":"report","user":"sin"};
                window.buss.sendMsg(JSON.stringify(js));
                }catch(e){
                    dbg("send e :"+e.name+":"+e.message);
                }
            }
            var MIN_IN_STATION_DIST=50;
            var mStartBus=false;
            function start_(){
                var ls=businfo.stations;
                if(DBG){
                    mLatestLoc=ls[1];
                }
                if(!mLatestLoc){
                    dbg("no Gps!!");
                    return;
                }
                mStartLoc=(mLatestLoc);
                var dist=MIN_IN_STATION_DIST;
                for(var i=0;i<ls.length;i++){
                    var thisdist=(getDisance(mStartLoc.la,mStartLoc.lo,ls[i].la,ls[i].lo));
                    dbg("thisdist from "+ls[i].stname+"="+thisdist);
                    $("#idstation"+i).css("color","#0000E3");//blue
                    if(thisdist<dist){
                        dist=thisdist;
                        mCurrStationIndex=i;
                        mNextSationIndex=i+1;
                        mStartBus=true;
                        $("#idstation"+mCurrStationIndex).css("color","#D26900");//yellow
                    }
                }
                if(mStartBus){
                    dbg("get start station "+ls[mCurrStationIndex].stname);
                    for(var i=0;i<mCurrStationIndex;i++){
                        $("#idstation"+i).css("color","#6C0000");//red for passed station
                    }
                    sendBusStatus({"type":"runbus","action":"start","lineid":businfo.lineid,"startInd":mCurrStationIndex});
                    $("#idstart").html("<button id='idstart' onclick='stop()'>stop</button>");
                    updateStaion();
                }else{
                    dbg("too far from any station");
                }
            }
            function sendBusStatus(jsmsg){
                dbg("sendBusStatus businfo.lineid="+businfo.lineid);
                if(businfo.lineid){
                    buss.sendMsg(JSON.stringify(jsmsg));
                }
            }
            function updateStaion(){//in station : yellow ; left staion : green , done station : red
                if(!mStartBus){
                    return;
                }
                dbg("u: cur="+mCurrStationIndex+",next="+mNextSationIndex);
                var ls=businfo.stations,dist,nextStationIndex,speedDistIndex,isIn,thisdist="";
                var tm=new Date().getTime();
                if(mCurrStationIndex>=0){
                    thisdist=(getDisance(mLatestLoc.la,mLatestLoc.lo,ls[mCurrStationIndex].la,ls[mCurrStationIndex].lo));
                    dbg("u:c: dist from cur "+ls[mCurrStationIndex].stname+" = "+thisdist);
                    //dbg(" >MIN="+(thisdist>MIN_IN_STATION_DIST)+" typeof thisdist= "+(typeof thisdist)+",typeof MIN="+(typeof MIN_IN_STATION_DIST));
                    $("#idstTm"+mCurrStationIndex).html(getHMS(tm));
                    if(thisdist>MIN_IN_STATION_DIST){//leave curr
                        $("#idstation"+mCurrStationIndex).css("color","#6C0000");//red
                        ls[mCurrStationIndex].leaveTm=tm;
                        $("#idstSpeed"+mCurrStationIndex).html("");
                        $("#idstDist"+mCurrStationIndex).html("");
                        mNextSationIndex=mCurrStationIndex+1;
                        mCurrStationIndex=-1;

                        thisdist=(getDisance(mLatestLoc.la,mLatestLoc.lo,ls[mNextSationIndex].la,ls[mNextSationIndex].lo));
                        updateDistSpeed(mNextSationIndex,thisdist,"next");
                    }else{
                        updateDistSpeed(mCurrStationIndex,thisdist,"in");
                    }
                }else if(mNextSationIndex>0 && mNextSationIndex<ls.length){
                    thisdist=(getDisance(mLatestLoc.la,mLatestLoc.lo,ls[mNextSationIndex].la,ls[mNextSationIndex].lo));
                    dbg("u:n: dist from next "+ls[mNextSationIndex].stname+" = "+thisdist+",tm="+getHMS(tm));
                    isIn=thisdist<=MIN_IN_STATION_DIST;
                    updateDistSpeed(mNextSationIndex,thisdist,isIn?"in":"next");
                    $("#idstTm"+mNextSationIndex).html(getHMS(tm));
                    if(isIn){//enter next
                        mCurrStationIndex=mNextSationIndex;
                        mNextSationIndex++;
                        $("#idstation"+mCurrStationIndex).css("color","#D26900");//yellow
                    }
                }

            }
            function updateDistSpeed(speedDistIndex,dist,status){
                $("#idstDist"+speedDistIndex).html("距离:"+dist);
                var speed= mLatestLoc.speed || 0;
                $("#idstSpeed"+speedDistIndex).html("速度:"+speed);
                sendBusStatus({"type":"runbus","action":"stUpdate","lineid":businfo.lineid,"status":status,"index":speedDistIndex,"speed":speed,"dist":dist});
            }
            function onGpsPos(loc){
                try{
                    mLatestLoc=JSON.parse(loc);
                    updateStaion();
                }catch(e){
                    dbg("us error:"+e.name+":"+e.message);
                }
            }
            function onWsMessage(msg){ //msg from websocket server
                dbg("msg :"+msg);
                var js=JSON.parse(msg);
                if(js.type=="re-querryid"){
                    jlh.setShp("id",js.userid);
                    dbg("onWsMessage id="+js.userid);
                    if(js.nickname){
                        jlh.setShp("nickname",js.nickname);
                    }
                    reportOnline(js.userid);
                }else if(js.type=='runbus'){//forward from server
                    if(mStartBus) return ;//start by myself,so ignore server msg
                    if(js.action=='start'){
                        onStartLine(js);
                    }
                }
            }
            function onStartLine(jsmsg){
                for(var i=0;i<jsmsg.startInd;i++){
                    if(i<jsmsg.startInd)
                        $("#idstation"+i).css("color","#6C0000");//red for passed station
                    else if(i==jsmsg.startInd)
                        $("#idstation"+i).css("color","#D26900");//yellow
                    else
                        $("#idstation"+i).css("color","#0000E3");//blue
                }
           
            }
            function toRad(d) {  return d * Math.PI / 180; }
            function getDisance(lat1, lng1, lat2, lng2) { //lat为纬度, lng为经度, 一定不要弄错
                //dbg("gd ["+lat1+","+lng1+"]->["+lat2+","+lng2+"]");
                var dis = 0;
                var radLat1 = toRad(lat1);
                var radLat2 = toRad(lat2);
                var deltaLat = radLat1 - radLat2;
                var deltaLng = toRad(lng1) - toRad(lng2);
                var dis = 2 * Math.asin(Math.sqrt(Math.pow(Math.sin(deltaLat / 2), 2) + Math.cos(radLat1) * Math.cos(radLat2) * Math.pow(Math.sin(deltaLng / 2), 2)));
                return parseInt(dis * 6378137);
            } 
        </script>
    </body>
</html>

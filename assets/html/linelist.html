<html>
    <head>
        <script src="../js/jquery_mini.js"></script>
        <link rel="stylesheet" type="text/css" href="../css/general.css">
        <style type="text/css">
            #idlines p {background:#d0d0d0;}
            #idlines p:active {background:#dd0000;}
        </style>
    </head>
    <body style="margin:0px">
        <table  class="titleTableHead" >
            <tr>
                <td></td>
                <td><h3 id="idBusname" align=center style="padding:16px;margin:0px;" >Lines</h3></td>
                <td><div id='idopr' align=right></div></td>
            </tr>
        </table>

        <div id="idlines" style="background:#d0d0d0">
        </div>
        <p id="console"></p>
        <script>
            function dbg(msg){
                $("#console").html(msg+"<br>"+$("#console").html());
            }
            function catchFuncExc(func){
                try{
                    func();
                }catch(e){
                    dbg(e);
                }
            }
            $(document).ready(function(){
                catchFuncExc(ready_());
            });
            function ready_(){
                dbg("ok ready sdcard");
                lines=window.jh.getShp("alllines");
                //dbg("lines="+lines);
                if(lines){
                    lines=lines.split(",");
                    var linehtml="";
                    for(var i=0;i<lines.length;i++){
                        if(!lines[i]){
                            continue;
                        }
                        var ln=jh.getShp(lines[i]);
                        if(!ln){
                            continue;
                        }
                        linehtml+="<p id='idLine"+i+"' onclick='showOpr("+i+")'>"+lines[i]+"</p>";
                        linehtml+="<p align='right' id='idopr"+i+"' style='display:none'  ><button onclick='selectline()' >select</button>";
                        linehtml+="<button onclick='deleteline()'>deleteline</button>";
                        var l=JSON.parse(ln);
                        dbg("line "+l.name+" ownid="+l.ownerid);
                        if(!l.ownerid){
                            linehtml+="<button onclick='uploadline()'>upload</button>";
                        }
                        linehtml+="</p>";
                    }
                    $("#idlines").html(linehtml);
                }
            }
            var mLastShowOprLine=-1;
            function showOpr(line){
                //dbg("showOpr line="+line+",last="+mLastShowOprLine);
                if(mLastShowOprLine!=-1){
                    $("#idopr"+mLastShowOprLine).css("display","none");
                }
                mLastShowOprLine=line;
                $("#idopr"+mLastShowOprLine).css("display","block");
            }
            function selectline(){
                window.jh.setShp("lastLine",lines[mLastShowOprLine]);
            }
            function deleteline(){
                window.jh.rmShp(lines[mLastShowOprLine]);
                lines.splice(mLastShowOprLine,1);
                window.jh.setShp("alllines",lines.join(","));
                $("#idLine"+mLastShowOprLine).css("display","none");
                $("#idopr"+mLastShowOprLine).css("display","none");
            }
            function uploadline(){
                var jsline=JSON.parse(jh.getShp(lines[mLastShowOprLine]));
                var js={"type":"uploadLine","stations":jsline.stations,
                    "name":jsline.name,"ownerid":jh.getShp("id")};
                jh.sendMsg(JSON.stringify(js));
            }
            function getHMS(timstap){
                var ts=new Date(parseInt(timstap) * 1000).toLocaleString();
                return ts.split(" ")[4];
            }
        </script>
    </body>
</html>
